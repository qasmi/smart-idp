---
name: Validate GitOps Manifests

on:
  pull_request:
    branches:
      - demo-luc

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: 'demo-cluster'
          config_data: |
            extends: default
            rules:
              line-length:
                max: 200
                level: warning
              comments:
                min-spaces-from-content: 1
          strict: false

      - name: Install kubeconform
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes/ArgoCD schemas
        run: |
          echo "ğŸ” Validating Kubernetes/ArgoCD schemas..."
          find demo-cluster -type f \( -name "*.yaml" -o -name "*.yml" \) \
            ! -path "*/.git/*" \
            ! -path "*/.k8s-gen/*" \
            -exec sh -c '
              if grep -q "kind:" "$1" && grep -q "apiVersion:" "$1"; then
                echo "Validating: $1"
                kubeconform -strict -summary "$1" || exit 1
              fi
            ' _ {} \;

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Render Helm charts from ArgoCD Applications
        run: |
          echo "ğŸ”§ Rendering Helm charts from ArgoCD Applications..."
          mkdir -p /tmp/rendered-manifests
          
          app_file="demo-cluster/.k8s-gen/app-manifest.yaml"
          chart=$(yq eval ".spec.source.chart" "$app_file")
          repo_url=$(yq eval ".spec.source.repoURL" "$app_file")
          target_revision=$(yq eval ".spec.source.targetRevision" "$app_file")
          values=$(yq eval ".spec.source.helm.values" "$app_file")
          
          echo "Rendering chart: $chart from $repo_url"
          
          repo_name=$(echo "$repo_url" | sed "s/[^a-zA-Z0-9]/-/g" | cut -c1-50)
          helm repo add "$repo_name" "$repo_url" || exit 1
          helm repo update "$repo_name"
          
          output_file="/tmp/rendered-manifests/app-manifest-${chart}-rendered.yaml"
          if [ -n "$values" ] && [ "$values" != "null" ] && [ "$values" != "|" ]; then
            values_file=$(mktemp)
            echo "$values" > "$values_file"
            helm template "$chart" "$repo_name/$chart" --version "$target_revision" --values "$values_file" > "$output_file"
            rm -f "$values_file"
          else
            helm template "$chart" "$repo_name/$chart" --version "$target_revision" > "$output_file"
          fi
          
          echo "âœ… Helm chart rendering complete"

      - name: Validate rendered Helm manifests
        run: |
          echo "ğŸ” Validating rendered Helm manifests..."
          if [ -d /tmp/rendered-manifests ] && [ "$(ls -A /tmp/rendered-manifests)" ]; then
            find /tmp/rendered-manifests -type f \( -name "*.yaml" -o -name "*.yml" \) \
              -exec sh -c '
                if grep -q "kind:" "$1" && grep -q "apiVersion:" "$1"; then
                  echo "Validating rendered manifest: $1"
                  kubeconform -strict -summary "$1" || exit 1
                fi
              ' _ {} \;
          else
            echo "  No rendered manifests to validate"
          fi

      - name: Prepare resources for Kyverno validation
        run: |
          echo "ğŸ“‹ Collecting Kubernetes resources for validation..."
          mkdir -p /tmp/kyverno-resources
          
          # Only copy rendered Helm manifests from app-manifest.yaml (excluding Applications)
          if [ -d /tmp/rendered-manifests ] && [ "$(ls -A /tmp/rendered-manifests)" ]; then
            find /tmp/rendered-manifests -type f \( -name "*.yaml" -o -name "*.yml" \) \
              -exec sh -c '
                if grep -q "kind:" "$1" && grep -q "apiVersion:" "$1" && ! grep -qE "^kind: Application$" "$1"; then
                  cp "$1" /tmp/kyverno-resources/
                  echo "  Found rendered: $1"
                fi
              ' _ {} \;
          fi
          
          echo "ğŸ“Š Total resources collected for Kyverno validation:"
          ls -1 /tmp/kyverno-resources/ | wc -l

      - name: Validate against Kyverno policies
        uses: ckotzbauer/kyverno-test-action@v2
        with:
          resource-files: '/tmp/kyverno-resources/*.yaml'
          policy-files: 'https://raw.githubusercontent.com/lucchmielowski/kyverno-mcp/refs/heads/main/pkg/tools/policies/pod-security.yaml'

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "âœ… All GitOps manifests validated successfully!"
          echo ""
          echo "ğŸ“‹ ArgoCD Applications found:"
          find demo-cluster -type f \( -name "*.yaml" -o -name "*.yml" \) \
            ! -path "*/.git/*" \
            -exec grep -l "kind: Application" {} \; | sed 's/^/  âœ“ /' || echo "  (none found)"
