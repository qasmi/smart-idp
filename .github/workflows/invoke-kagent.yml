name: Invoke KAgent

on:
  push:
    branches:
      - main

jobs:
  invoke-kagent:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: requirements
        run: |
          curl https://raw.githubusercontent.com/kagent-dev/kagent/refs/heads/main/scripts/get-kagent | bash
        
          PROMPT_FILE="./ci-manifest-prompt.txt"
          cat > "$PROMPT_FILE" <<EOF
          Compare the live state of the cluster with the following manifest. Briefly summarize any misconfigurations or risks that would occur if the manifest is applied. Focus only on real diffs that affect resources, and give very short answers:
          $(< demo-cluster/.k8s-gen/manifests.yaml)
          EOF

      - name: Invoke KAgent
        run: |
          PROMPT_FILE="./ci-manifest-prompt.txt"
          kagent --kagent-url "http://demo-smart-idp.uk" invoke --agent k8s-agent --file $PROMPT_FILE  \
          | jq -r '.result.status.message.parts[0].text'
